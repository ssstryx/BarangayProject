@using BarangayProject.Models.AdminModel
@model List<Sitio>

@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "List of Sitios";
    var currentSearch = ViewBag.CurrentSearch as string ?? "";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

<div class="container-fluid py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-1 fw-bold">List of Sitios</h2>
        </div>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mt-2">@TempData["ErrorMessage"]</div>
    }

    <div class="row mb-3 mt-3">
        <div class="col-md-8">
            <form method="get" asp-action="ManageSitios" class="d-flex" id="sitiosSearchForm">
                <input id="sitiosSearchInput" name="search" value="@currentSearch" class="form-control me-2" placeholder="Type to search..." autocomplete="off" />
                <button id="sitiosSearchBtn" class="btn btn-primary me-2" type="submit">Search</button>
                <a class="btn btn-outline-secondary" href="@Url.Action("ManageSitios", "Admin")">Clear</a>
            </form>
        </div>
    </div>

    <!-- table card: matches Manage Users look -->
    <div class="card p-3 shadow-sm">
        <div class="table-responsive">
            <table id="sitiosTable" class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width:120px">Sitio ID</th>
                        <th>Sitio Name</th>
                        <th>Assigned BHW</th>
                        <th style="width:260px">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var any = Model?.Any() ?? false;
                        if (!any)
                        {
                            <tr class="no-results-placeholder">
                                <td colspan="4" class="text-center text-muted py-4">No sitios found.</td>
                            </tr>
                        }
                        else
                        {
                            foreach (var s in Model)
                            {
                                // Build the JS-confirmation message in Razor to avoid mixing C# inside attribute area
                                var sitioNameForConfirm = (s?.Name ?? "").Replace("'", "\\'").Replace("\"", "\\\"");
                                var confirmMsg = $"Delete sitio \\\"{sitioNameForConfirm}\\\"? This cannot be undone.";

                                <tr data-sitioid="@s.Id" data-sitioname="@s.Name">
                                    <td class="text-mono small id-cell">@s.Id</td>
                                    <td>@s.Name</td>
                                    <td>
                                        @* Show assigned BHW names (friendly). If many, join with commas. If none show Unassigned *@
                                        @if (s.SitioBhws != null && s.SitioBhws.Any())
                                        {
                                            var names = s.SitioBhws.Select(sb => sb.Bhw != null
                                            ? (!string.IsNullOrWhiteSpace(sb.Bhw.DisplayName) ? sb.Bhw.DisplayName : sb.Bhw.UserName ?? sb.Bhw.Id)
                                            : sb.BhwId).ToList();

                                            // render as plain text (comma separated) to match Manage Users compact look
                                            <span>@string.Join(", ", names)</span>
                                        }
                                        else if (!string.IsNullOrWhiteSpace(s.AssignedBhwId))
                                        {
                                            <span>@s.AssignedBhwId</span>
                                        }
                                        else
                                        {
                                            <em class="text-muted">Unassigned</em>
                                        }
                                    </td>
                                    <td>
                                        <a asp-action="EditSitio" asp-route-id="@s.Id" class="btn btn-outline-primary btn-sm me-1">Edit</a>

                                        <form method="post" asp-action="DeleteSitio" asp-route-id="@s.Id" class="d-inline me-1"
                                              onsubmit="return confirm('@confirmMsg');">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* small styles reused from Manage Users for identical look */
    .text-mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
    }

    .id-cell {
        color: #495057;
    }
    /* keep table compact and consistent */
    table.table thead th {
        font-weight: 600;
        background: #fff;
        border-bottom: 1px solid #e9ecef;
        color: #222;
    }

    table.table tbody tr td {
        padding: .65rem 12px;
        vertical-align: middle;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        (function () {
            // Toast from TempData (server-side)
            const succ = '@(TempData["SuccessMessage"] ?? "")';
            const err = '@(TempData["ErrorMessage"] ?? "")';
            if (succ && succ.trim() !== '') {
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: succ, showConfirmButton: false, timer: 2200 });
            } else if (err && err.trim() !== '') {
                Swal.fire({ toast: true, position: 'top-end', icon: 'error', title: err, showConfirmButton: false, timer: 2800 });
            }

            // Ensure search form submits normally (no JS interference)
            const form = document.getElementById('sitiosSearchForm');
            if (form) form.onsubmit = null;
            const btn = document.getElementById('sitiosSearchBtn');
            if (btn) btn.type = 'submit';
        })();
    </script>
}
