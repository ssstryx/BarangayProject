

@model BarangayProject.Controllers.AssignBhwVm
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Assign BHWs";
}

using BarangayProject.Controllers;

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-9">
            <h3 class="mb-4">Assign BHW(s) to Sitio: <strong>@Model.SitioName</strong></h3>

            <!-- CURRENT ASSIGNMENTS -->
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <h6 class="mb-3">Currently assigned BHW(s)</h6>

                    @if (Model.SelectedBhwIds != null && Model.SelectedBhwIds.Any())
                    {
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th style="width:1%">#</th>
                                    <th>Name</th>
                                    <th style="width:1%"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var idx = 1;
                                }
                                @foreach (var bhwId in Model.SelectedBhwIds)
                                {
                                    var name = Model.SelectedBhwLabels != null && Model.SelectedBhwLabels.TryGetValue(bhwId, out var lbl) ? lbl : (Model.AvailableBHWs?.FirstOrDefault(x => x.Value == bhwId)?.Text ?? bhwId);
                                    <tr id="assigned-row-@bhwId">
                                        <td>@idx</td>
                                        <td>@name</td>
                                        <td class="text-end">
                                            <form asp-action="RemoveAssignedBhw" asp-controller="Admin" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="sitioId" value="@Model.SitioId" />
                                                <input type="hidden" name="bhwId" value="@bhwId" />
                                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Remove this BHW assignment?');">
                                                    Remove
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    idx++;
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="text-muted">No BHWs currently assigned to this sitio.</div>
                    }
                </div>
            </div>

            <!-- ASSIGN NEW / EDIT MULTI-SELECT -->
            <form asp-action="AssignBhw" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="sitioId" value="@Model.SitioId" />

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Select one or more BHWs to assign</label>

                            <select name="selectedBhwIds" multiple size="10" class="form-select">
                                @* show available BHWs - those in AvailableBHWs (controller should filter out already-assigned BHWs except preSelected) *@
                                @foreach (var item in Model.AvailableBHWs)
                                {
                                    <option value="@item.Value" selected="@(item.Selected ? "selected" : null)">@item.Text</option>
                                }
                            </select>

                            <div class="form-text">Use Ctrl/Cmd+click or Shift+click to select multiple. Selected BHWs will be assigned to this sitio.</div>
                        </div>
                    </div>

                    <div class="card-footer d-flex justify-content-between">
                        <a asp-action="ManageSitios" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Save assignments</button>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        // keep the original selected-count UI
        (function () {
            const sel = document.querySelector('select[name="selectedBhwIds"]');
            if (!sel) return;

            // create selected-count info element if not exists
            let info = sel.parentElement.querySelector('.bhw-selected-info');
            if (!info) {
                info = document.createElement('div');
                info.className = 'mt-2 small text-muted bhw-selected-info';
                sel.parentElement.appendChild(info);
            }

            const updateInfo = () => {
                const c = Array.from(sel.selectedOptions).length;
                info.textContent = c ? (c + ' selected') : 'No BHW selected';
            };

            // Toggle selection on single-click (mousedown) so users don't need to use Ctrl/Cmd
            // We use mousedown + preventDefault to stop native single-select behavior,
            // then toggle the option's selected state manually.
            sel.addEventListener('mousedown', function (e) {
                // only act if the target is an option
                if (e.target && e.target.tagName && e.target.tagName.toLowerCase() === 'option') {
                    e.preventDefault(); // stop the browser from changing selection the normal way
                    const opt = e.target;
                    // toggle selected
                    opt.selected = !opt.selected;

                    // Fire a change event so any other listeners (and form state) update
                    const evt = new Event('change', { bubbles: true });
                    sel.dispatchEvent(evt);
                }
            });

            // keyboard support: allow Space to toggle focused option (useful for accessibility)
            sel.addEventListener('keydown', function (e) {
                if (e.key === ' ' || e.key === 'Spacebar') {
                    e.preventDefault();
                    const idx = sel.selectedIndex;
                    // If there is no focused option, ignore.
                    if (idx >= 0) {
                        const opt = sel.options[idx];
                        opt.selected = !opt.selected;
                        sel.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });

            sel.addEventListener('change', updateInfo);
            updateInfo();
        })();
    </script>
}


