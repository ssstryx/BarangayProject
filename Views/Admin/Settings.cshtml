@model SettingsViewModel
@using System.Security.Claims
@using BarangayProject.Models.AdminModel
@{
    ViewData["Title"] = "Settings";
    Layout = "_AdminLayout";
    var currentUserId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
}

<div class="container-fluid py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="page-title mb-0">Settings</h1>
    </div>

    <form asp-action="Settings" asp-controller="Admin" method="post" enctype="multipart/form-data" id="settingsForm" novalidate>
        @Html.AntiForgeryToken()
        <!-- Hidden field that the JS sets so controller can detect which button was used -->
        <input type="hidden" id="submitButton" name="submitButton" value="" />

        <!-- SYSTEM PREFERENCES -->
        <div class="card mb-4 shadow-sm rounded-3 border-0">
            <div class="card-header bg-primary text-white rounded-top-3">
                <strong class="card-title">System Preferences</strong>
            </div>

            <div class="card-body p-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-3 text-center">
                        <img id="previewLogo" src="@(Model.LogoPath ?? "/images/logo.png")"
                             class="img-fluid rounded-3 border" style="max-width:110px; max-height:110px; object-fit:cover;" />
                    </div>

                    <div class="col-md-9">
                        <div class="mb-3">
                            <label class="form-label field-label">System Name</label>
                            <input asp-for="SystemName" class="form-control unified-input" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label field-label">Upload Logo</label>
                            <div class="d-flex gap-2 align-items-center">
                                <!-- ensure asp-for matches the viewmodel property: SiteLogoUpload -->
                                <input asp-for="SiteLogoUpload" id="fileLogo" name="SiteLogoUpload" type="file" accept="image/*" class="form-control unified-input-file" />
                                <button type="button" id="clearLogoBtn" class="btn btn-outline-secondary btn-sm" style="height:38px; display:none;">Clear</button>
                            </div>
                            <div class="form-text">Selecting a file previews the chosen file; save settings to persist the logo.</div>
                        </div>
                    </div>
                </div>
            </div>  
        </div>

        <!-- CHANGE PASSWORD -->
        <div class="card mb-4 shadow-sm rounded-3 border-0">
            <div class="card-header bg-white border-bottom rounded-top-3">
                <strong class="card-title">Change Admin Password</strong>
            </div>

            <div class="card-body p-3">
                <div class="row gy-3 align-items-center">
                    <div class="col-12 col-md-6">
                        <label class="form-label field-label">New Password</label>
                        <div class="input-with-icon">
                            <!-- NOTE: set type="password" so the toggle works -->
                            <input asp-for="ResetNewPassword" id="newPassword" type="password" class="form-control pw-input unified-input" autocomplete="new-password" />
                            <button type="button" class="btn-eye" id="toggleNewPw" aria-label="Show password"><i class="bi bi-eye"></i></button>
                        </div>
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label field-label">Confirm Password</label>
                        <div class="input-with-icon">
                            <input asp-for="ResetNewPasswordConfirm" id="confirmPassword" type="password" class="form-control pw-input unified-input" autocomplete="new-password" />
                            <button type="button" class="btn-eye" id="toggleConfirmPw" aria-label="Show confirm"><i class="bi bi-eye"></i></button>
                        </div>
                    </div>

                    <div class="col-12">
                        <div id="pwHints" class="pw-hints-vertical mt-2">
                            <div class="pw-hint"><span class="hint-dot" id="h-length"></span><span class="hint-text">Minimum <strong id="hint-length-value">8</strong> characters</span></div>
                            <div class="pw-hint"><span class="hint-dot" id="h-upper"></span><span class="hint-text">One uppercase character</span></div>
                            <div class="pw-hint"><span class="hint-dot" id="h-lower"></span><span class="hint-text">One lowercase character</span></div>
                            <div class="pw-hint"><span class="hint-dot" id="h-number"></span><span class="hint-text">One number</span></div>
                            <div class="pw-hint"><span class="hint-dot" id="h-special"></span><span class="hint-text">One special character</span></div>
                        </div>
                        <div id="pw-msg" class="small text-danger mt-2" style="display:none;">Please fix password issues above to enable change.</div>
                    </div>
                </div>

                <input asp-for="ResetUserId" id="resetUserId" type="hidden" value="@currentUserId" />
            </div>

            <div class="card-footer bg-white border-0 d-flex justify-content-end gap-3">
                <!-- important: name="submitButton" with value the controller expects
                     Use type="button" so JS can set hidden field then submit explicitly -->
                <button type="button" id="btnSaveSettings" name="submitButton" value="saveSettings" class="btn btn-outline-primary rounded-pill px-4 py-2">
                    <i class="bi bi-save me-2"></i> Save Settings
                </button>

                <button type="button" id="btnChangePassword" name="submitButton" value="changePassword" class="btn btn-primary rounded-pill px-4 py-2">
                    <i class="bi bi-check2-square me-2"></i> Change Password
                </button>
            </div>
        </div>
    </form>
</div>

<style>
    /* (keep your existing CSS) */
    .page-title {
        font-size: 34px;
        font-weight: 700;
        letter-spacing: -0.2px;
    }

    .field-label {
        font-size: .95rem;
        color: #333;
        font-weight: 600;
    }

    .unified-input, .unified-input-file {
        width: 100%;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        padding: .55rem .75rem;
        height: 44px;
        font-size: .95rem;
        background: #fff;
    }

    .unified-input-file {
        height: 38px;
        padding: .35rem .6rem;
    }

    .input-with-icon {
        position: relative;
        width: 100%;
        display: block;
    }

        .input-with-icon .unified-input {
            padding-right: 46px;
        }

    .btn-eye {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        border: 0;
        background: transparent;
        padding: .35rem;
        color: #495057;
        cursor: pointer;
    }

    .pw-input.valid {
        border-color: #198754;
        box-shadow: 0 0 0 .08rem rgba(25,135,84,0.08);
    }

    .pw-input.invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 .08rem rgba(220,53,69,0.06);
    }

    /* ---------- tweak: align dot + text and add spacing ---------- */
    .pw-hints-vertical {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
        max-width: 420px;
    }

    /* Make each hint a flex row so dot and text align with spacing */
    .pw-hint {
        display: flex;
        align-items: center;
        gap: 10px; /* space between dot and text - change as needed */
        font-size: 0.98rem;
        color: #333;
    }

    .hint-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #e9ecef;
        display: inline-block;
        flex: none; /* keep fixed size */
    }

        .hint-dot.ok {
            background: #198754;
        }

        .hint-dot.fail {
            background: #dc3545;
        }

    .card-body {
        padding: .9rem;
    }

    .card-footer {
        padding: .6rem .9rem;
    }

    @@media (max-width:767px) {
        .page-title {
            font-size: 28px;
        }

        .pw-hints-vertical {
            max-width: 100%;
        }
    }
</style>

@section Scripts {
    <script>
        (function () {
            const minLen = 8;
            const hintLengthEl = document.getElementById('hint-length-value');
            if (hintLengthEl) hintLengthEl.innerText = minLen;

            const newPw = document.getElementById('newPassword');
            const confirmPw = document.getElementById('confirmPassword');
            const toggleNew = document.getElementById('toggleNewPw');
            const toggleConfirm = document.getElementById('toggleConfirmPw');
            const saveBtn = document.getElementById('btnSaveSettings');
            const changeBtn = document.getElementById('btnChangePassword');
            const pwMsg = document.getElementById('pw-msg');

            const hLen = document.getElementById('h-length');
            const hUpper = document.getElementById('h-upper');
            const hLower = document.getElementById('h-lower');
            const hNumber = document.getElementById('h-number');
            const hSpecial = document.getElementById('h-special');

            const fileLogo = document.getElementById('fileLogo');
            const preview = document.getElementById('previewLogo');
            const clearLogoBtn = document.getElementById('clearLogoBtn');

            const submitField = document.getElementById('submitButton');
            const settingsForm = document.getElementById('settingsForm');

            function togglePw(btn, field) {
                if (!field) return;
                if (field.type === 'password') { field.type = 'text'; btn.innerHTML = '<i class="bi bi-eye-slash"></i>'; }
                else { field.type = 'password'; btn.innerHTML = '<i class="bi bi-eye"></i>'; }
                field.focus();
            }
            toggleNew?.addEventListener('click', () => togglePw(toggleNew, newPw));
            toggleConfirm?.addEventListener('click', () => togglePw(toggleConfirm, confirmPw));

            function testPassword(p) {
                return {
                    length: p.length >= minLen,
                    upper: /[A-Z]/.test(p),
                    lower: /[a-z]/.test(p),
                    number: /\d/.test(p),
                    special: /[^A-Za-z0-9]/.test(p)
                };
            }

            function updateHints(r) {
                setDot(hLen, r.length);
                setDot(hUpper, r.upper);
                setDot(hLower, r.lower);
                setDot(hNumber, r.number);
                setDot(hSpecial, r.special);
            }

            function setDot(el, ok) {
                if (!el) return;
                el.classList.remove('ok','fail');
                el.classList.add(ok ? 'ok' : 'fail');
            }

            function setFieldState(field, ok) {
                if (!field) return;
                field.classList.remove('valid','invalid');
                if (field.value.length === 0) return;
                field.classList.add(ok ? 'valid' : 'invalid');
            }

            function validatePasswordFields() {
                const p = (newPw && newPw.value) ? newPw.value : '';
                const c = (confirmPw && confirmPw.value) ? confirmPw.value : '';
                const rules = testPassword(p);
                const allOk = rules.length && rules.upper && rules.lower && rules.number && rules.special;
                updateHints(rules);
                setFieldState(newPw, allOk);
                setFieldState(confirmPw, (c.length > 0 && c === p));
                const okConfirm = (p === c && c.length > 0);
                return { allow: allOk && okConfirm, rules, p, c };
            }

            newPw?.addEventListener('input', () => { if (pwMsg) pwMsg.style.display = 'none'; validatePasswordFields(); });
            confirmPw?.addEventListener('input', () => { if (pwMsg) pwMsg.style.display = 'none'; validatePasswordFields(); });

            // Logo file preview
            fileLogo?.addEventListener('change', function (e) {
                const f = e.target.files && e.target.files[0];
                if (f) { preview.src = URL.createObjectURL(f); clearLogoBtn.style.display = 'inline-block'; }
                else { clearLogoBtn.style.display = 'none'; }
            });

            clearLogoBtn?.addEventListener('click', function () {
                if (fileLogo) fileLogo.value = '';
                clearLogoBtn.style.display = 'none';
                preview.src = "@(Model.LogoPath ?? "/images/logo.png")";
            });

            // Utility: disable password inputs so browsers won't include them in the POST
            function disablePasswordFields() {
                if (newPw) newPw.disabled = true;
                if (confirmPw) confirmPw.disabled = true;
            }
            function enablePasswordFields() {
                if (newPw) newPw.disabled = false;
                if (confirmPw) confirmPw.disabled = false;
            }

            // SAVE SETTINGS (do NOT submit password fields)
            saveBtn?.addEventListener('click', function (e) {
                if (submitField) submitField.value = 'saveSettings';

                // disable password fields so they aren't posted
                disablePasswordFields();

                // now submit
                settingsForm && settingsForm.submit();
            });

            // CHANGE PASSWORD (validate then submit with password fields enabled)
            changeBtn?.addEventListener('click', function (e) {
                if (submitField) submitField.value = 'changePassword';

                // ensure password inputs are enabled for the change flow
                enablePasswordFields();

                const valid = validatePasswordFields();
                if (!valid.allow) {
                    if (pwMsg) {
                        pwMsg.style.display = '';
                        pwMsg.innerText = "Please fix password requirements and ensure confirmation matches.";
                    }
                    return;
                }

                settingsForm && settingsForm.submit();
            });

            // fallback: native form submit (Enter key etc.)
            settingsForm?.addEventListener('submit', function (e) {
                // if hidden field empty, default to saveSettings
                if (!submitField.value) {
                    submitField.value = 'saveSettings';
                }

                if (submitField.value === 'saveSettings') {
                    // ensure password fields are disabled for save flow
                    disablePasswordFields();
                    // allow the submit to proceed
                } else if (submitField.value === 'changePassword') {
                    // enable + validate
                    enablePasswordFields();
                    const valid = validatePasswordFields();
                    if (!valid.allow) {
                        e.preventDefault();
                        if (pwMsg) pwMsg.style.display = '';
                    }
                } else {
                    // unknown action: be safe and disable password fields
                    disablePasswordFields();
                }
            });

            // make sure password fields are enabled by default for user interaction (page load)
            enablePasswordFields();
            validatePasswordFields();
        })();
    </script>
}
