@using BarangayProject.Models.BhwModel
@model CreateHouseholdVm
@{
    Layout = "~/Views/Shared/_BhwLayout.cshtml";
    ViewData["Title"] = "Edit Household";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

<style>
    /* compact, consistent form visuals (same as CreateHousehold) */
    .card.form-section {
        padding: 1.05rem;
        border-radius: .5rem;
    }

    .form-label.small {
        font-size: .88rem;
        font-weight: 600;
        color: #333;
    }

    .form-control.form-control-sm, .form-select.form-select-sm {
        height: 40px;
        padding: .45rem .6rem;
        font-size: .95rem;
    }

    .input-age {
        width: 90px;
        text-align: center;
    }

    #addChildBtn {
        height: 38px;
    }

    /* child card styling and top-right remove button */
    .child-row {
        background: #fff;
        border: 1px solid rgba(0,0,0,0.06);
        border-radius: 8px;
        position: relative;
    }

        .child-row .remove-child {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 2;
        }

        .child-row .form-control.form-control-sm,
        .child-row .form-select.form-select-sm {
            height: 40px;
            padding: .45rem .6rem;
        }

        .child-row .child-age {
            width: 86px;
            text-align: center;
        }

    @@media (max-width:768px) {
        .input-age {
            width: 72px;
        }

        .form-control.form-control-sm {
            height: 38px;
        }
    }
</style>

<div class="container-fluid py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-1 fw-bold">Edit Household</h2>
            <p class="text-muted mb-0">Update household information.</p>
        </div>
    </div>

    <form id="editHouseholdForm" asp-action="EditHousehold" method="post" class="needs-validation" novalidate>
        @Html.AntiForgeryToken()

        <div class="mb-2">
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
            }
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success">@TempData["SuccessMessage"]</div>
            }
        </div>

        <!-- Parents -->
        <h5 class="section-title">Basic Information</h5>

        <div class="card form-section mb-3">
            <h6 class="mb-2">Father's Information</h6>
            <div class="row gx-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">First Name</label>
                    <input asp-for="FatherFirstName" class="form-control form-control-sm" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Middle Name</label>
                    <input asp-for="FatherMiddleName" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Last Name</label>
                    <input asp-for="FatherLastName" class="form-control form-control-sm" />
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Ext</label>
                    <input asp-for="FatherExtension" class="form-control form-control-sm" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Date of Birth</label>
                    <input asp-for="FatherDateOfBirth" type="date" class="form-control form-control-sm parent-dob" id="FatherDateOfBirth" />
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Age</label>
                    <input asp-for="FatherAge" class="form-control form-control-sm input-age" id="FatherAge" readonly />
                </div>
            </div>

            <div class="row gx-2 mt-2">
                <div class="col-md-6">
                    <label class="form-label small">Occupation</label>
                    <select asp-for="FatherOccupation" class="form-select form-select-sm parent-occupation-select" id="FatherOccupationSelect">
                        <option value="">Select...</option>
                        <option>Unemployed</option>
                        <option>Student</option>
                        <option>Housewife / Housekeeper</option>
                        <option>Farmer</option>
                        <option>Fisherman</option>
                        <option>Driver</option>
                        <option>Laborer</option>
                        <option>Vendor</option>
                        <option>Teacher</option>
                        <option>Nurse</option>
                        <option>Office Worker / Clerk</option>
                        <option>Construction Worker</option>
                        <option>Security Guard</option>
                        <option>Business Owner</option>
                        <option>Factory Worker</option>
                        <option>Carpenter</option>
                        <option>Electrician</option>
                        <option>Plumber</option>
                        <option>Others</option>
                    </select>
                    <input asp-for="FatherOccupationOther" id="FatherOccupationOther" class="form-control form-control-sm mt-2 parent-occupation-other" placeholder="Please specify occupation" style="display:none;" />
                </div>

                <div class="col-md-6">
                    <label class="form-label small">Educational Attainment</label>
                    <select asp-for="FatherEducation" class="form-select form-select-sm" id="FatherEducationSelect">
                        <option value="">Select...</option>
                        <option>Elementary Graduate</option>
                        <option>High School Graduate</option>
                        <option>College Graduate</option>
                        <option>Vocational / Technical Graduate</option>
                        <option>Others</option>
                    </select>
                    <input asp-for="FatherEducationOther" id="FatherEducationOther" class="form-control form-control-sm mt-2 parent-education-other" placeholder="Please specify educational attainment" style="display:none;" />
                </div>
            </div>

            <input type="hidden" asp-for="FatherSex" value="Male" />
        </div>

        <div class="card form-section mb-3">
            <h6 class="mb-2">Mother's Information</h6>

            <div class="row gx-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small">First Name</label>
                    <input asp-for="MotherFirstName" class="form-control form-control-sm" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Middle Name</label>
                    <input asp-for="MotherMiddleName" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Last Name</label>
                    <input asp-for="MotherLastName" class="form-control form-control-sm" />
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Ext</label>
                    <input asp-for="MotherExtension" class="form-control form-control-sm" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Date of Birth</label>
                    <input asp-for="MotherDateOfBirth" type="date" class="form-control form-control-sm parent-dob" id="MotherDateOfBirth" />
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Age</label>
                    <input asp-for="MotherAge" class="form-control form-control-sm input-age" id="MotherAge" readonly />
                </div>
            </div>

            <div class="row gx-2 mt-2">
                <div class="col-md-6">
                    <label class="form-label small">Occupation</label>
                    <select asp-for="MotherOccupation" class="form-select form-select-sm parent-occupation-select" id="MotherOccupationSelect">
                        <option value="">Select...</option>
                        <option>Unemployed</option>
                        <option>Student</option>
                        <option>Housewife / Housekeeper</option>
                        <option>Farmer</option>
                        <option>Fisherman</option>
                        <option>Driver</option>
                        <option>Laborer</option>
                        <option>Vendor</option>
                        <option>Teacher</option>
                        <option>Nurse</option>
                        <option>Office Worker / Clerk</option>
                        <option>Construction Worker</option>
                        <option>Security Guard</option>
                        <option>Business Owner</option>
                        <option>Factory Worker</option>
                        <option>Carpenter</option>
                        <option>Electrician</option>
                        <option>Plumber</option>
                        <option>Others</option>
                    </select>
                    <input asp-for="MotherOccupationOther" id="MotherOccupationOther" class="form-control form-control-sm mt-2 parent-occupation-other" placeholder="Please specify occupation" style="display:none;" />
                </div>

                <div class="col-md-6">
                    <label class="form-label small">Educational Attainment</label>
                    <select asp-for="MotherEducation" class="form-select form-select-sm" id="MotherEducationSelect">
                        <option value="">Select...</option>
                        <option>Elementary Graduate</option>
                        <option>High School Graduate</option>
                        <option>College Graduate</option>
                        <option>Vocational / Technical Graduate</option>
                        <option>Others</option>
                    </select>
                    <input asp-for="MotherEducationOther" id="MotherEducationOther" class="form-control form-control-sm mt-2 parent-education-other" placeholder="Please specify educational attainment" style="display:none;" />
                </div>
            </div>

            <input type="hidden" asp-for="MotherSex" value="Female" />
        </div>

        <!-- Children -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Children's Information</h5>
            <button type="button" id="addChildBtn" class="btn btn-sm btn-primary">Add Child</button>
        </div>

        <div id="childrenContainer" class="mb-3">
            @for (int i = 0; i < (Model.Children?.Count ?? 0); i++)
            {
                var child = Model.Children[i];
                var childOcc = child?.Occupation ?? "";
                var occOtherVal = child?.OccupationOther ?? "";
                var childEdu = child?.Education ?? "";
                var eduOtherVal = child?.EducationOther ?? "";
                var childSex = child?.Sex ?? "";

                <div class="card mb-3 p-3 child-row" data-index="@i">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-child" aria-label="Remove child" title="Remove child">Remove</button>

                    <div class="row gx-2 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small">First Name</label>
                            <input name="Children[@i].FirstName" value="@child?.FirstName" class="form-control form-control-sm" />
                        </div>

                        <div class="col-md-2">
                            <label class="form-label small">Middle Name</label>
                            <input name="Children[@i].MiddleName" value="@child?.MiddleName" class="form-control form-control-sm" />
                        </div>

                        <div class="col-md-2">
                            <label class="form-label small">Last Name</label>
                            <input name="Children[@i].LastName" value="@child?.LastName" class="form-control form-control-sm" />
                        </div>

                        <div class="col-md-2">
                            <label class="form-label small">Extension</label>
                            <input name="Children[@i].Extension" value="@child?.Extension" class="form-control form-control-sm" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Date of Birth</label>
                            <input name="Children[@i].DateOfBirth" type="date" value="@(child?.DateOfBirth?.ToString("yyyy-MM-dd") ?? "")" class="form-control form-control-sm child-dob" />
                        </div>
                    </div>

                    <div class="row gx-2 mt-2 align-items-end">
                        <div class="col-md-1">
                            <label class="form-label small">Age</label>
                            <input name="Children[@i].Age" value="@(child?.Age?.ToString() ?? "")" class="form-control form-control-sm child-age" readonly />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Occupation</label>
                            <select name="Children[@i].Occupation" class="form-select form-select-sm child-occupation-select">
                                @Html.Raw("<option value=\"\">Select...</option>")
                                @Html.Raw("<option value=\"Unemployed\"" + (childOcc == "Unemployed" ? " selected" : "") + ">Unemployed</option>")
                                @Html.Raw("<option value=\"Student\"" + (childOcc == "Student" ? " selected" : "") + ">Student</option>")
                                @Html.Raw("<option value=\"Housewife / Housekeeper\"" + (childOcc == "Housewife / Housekeeper" ? " selected" : "") + ">Housewife / Housekeeper</option>")
                                @Html.Raw("<option value=\"Farmer\"" + (childOcc == "Farmer" ? " selected" : "") + ">Farmer</option>")
                                @Html.Raw("<option value=\"Fisherman\"" + (childOcc == "Fisherman" ? " selected" : "") + ">Fisherman</option>")
                                @Html.Raw("<option value=\"Driver\"" + (childOcc == "Driver" ? " selected" : "") + ">Driver</option>")
                                @Html.Raw("<option value=\"Laborer\"" + (childOcc == "Laborer" ? " selected" : "") + ">Laborer</option>")
                                @Html.Raw("<option value=\"Vendor\"" + (childOcc == "Vendor" ? " selected" : "") + ">Vendor</option>")
                                @Html.Raw("<option value=\"Teacher\"" + (childOcc == "Teacher" ? " selected" : "") + ">Teacher</option>")
                                @Html.Raw("<option value=\"Nurse\"" + (childOcc == "Nurse" ? " selected" : "") + ">Nurse</option>")
                                @Html.Raw("<option value=\"Office Worker / Clerk\"" + (childOcc == "Office Worker / Clerk" ? " selected" : "") + ">Office Worker / Clerk</option>")
                                @Html.Raw("<option value=\"Construction Worker\"" + (childOcc == "Construction Worker" ? " selected" : "") + ">Construction Worker</option>")
                                @Html.Raw("<option value=\"Security Guard\"" + (childOcc == "Security Guard" ? " selected" : "") + ">Security Guard</option>")
                                @Html.Raw("<option value=\"Business Owner\"" + (childOcc == "Business Owner" ? " selected" : "") + ">Business Owner</option>")
                                @Html.Raw("<option value=\"Factory Worker\"" + (childOcc == "Factory Worker" ? " selected" : "") + ">Factory Worker</option>")
                                @Html.Raw("<option value=\"Carpenter\"" + (childOcc == "Carpenter" ? " selected" : "") + ">Carpenter</option>")
                                @Html.Raw("<option value=\"Electrician\"" + (childOcc == "Electrician" ? " selected" : "") + ">Electricician</option>")
                                @Html.Raw("<option value=\"Plumber\"" + (childOcc == "Plumber" ? " selected" : "") + ">Plumber</option>")
                                @Html.Raw("<option value=\"Others\"" + (childOcc == "Others" ? " selected" : "") + ">Others</option>")
                            </select>

                            <input name="Children[@i].OccupationOther"
                                   value="@(occOtherVal ?? "")"
                                   class="form-control form-control-sm mt-2 child-occupation-other"
                                   placeholder="Please specify"
                                   style="display:@(childOcc == "Others" ? "block" : "none");" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Sex</label>
                            <select name="Children[@i].Sex" class="form-select form-select-sm">
                                @Html.Raw("<option value=\"\">Select...</option>")
                                @Html.Raw("<option value=\"Female\"" + (childSex == "Female" ? " selected" : "") + ">Female</option>")
                                @Html.Raw("<option value=\"Male\"" + (childSex == "Male" ? " selected" : "") + ">Male</option>")
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Educational Attainment</label>
                            <select name="Children[@i].Education" class="form-select form-select-sm child-education-select">
                                @Html.Raw("<option value=\"\">Select...</option>")
                                @Html.Raw("<option value=\"Elementary Graduate\"" + (childEdu == "Elementary Graduate" ? " selected" : "") + ">Elementary Graduate</option>")
                                @Html.Raw("<option value=\"High School Graduate\"" + (childEdu == "High School Graduate" ? " selected" : "") + ">High School Graduate</option>")
                                @Html.Raw("<option value=\"College Graduate\"" + (childEdu == "College Graduate" ? " selected" : "") + ">College Graduate</option>")
                                @Html.Raw("<option value=\"Others\"" + (childEdu == "Others" ? " selected" : "") + ">Others</option>")
                            </select>
                            <input name="Children[@i].EducationOther" value="@(eduOtherVal ?? "")" class="form-control form-control-sm mt-2 child-education-other" placeholder="Please specify" style="display:@(childEdu == "Others" ? "block" : "none");" />
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Health, Sanitation, Buttons (same as Create) -->
        <h5 class="mt-3">Health Information</h5>
        <div class="card p-3 mb-3">
            <div class="d-flex flex-wrap align-items-center mb-2">
                <div class="form-check me-4">
                    <input class="form-check-input" asp-for="MotherPregnant" />
                    <label class="form-check-label">Mother Pregnant</label>
                </div>
                <div class="form-check me-4">
                    <input class="form-check-input" asp-for="FamilyPlanning" />
                    <label class="form-check-label">Family Planning</label>
                </div>
                <div class="form-check me-4">
                    <input class="form-check-input" asp-for="ExclusiveBreastfeeding" />
                    <label class="form-check-label">Exclusive Breastfeeding</label>
                </div>
                <div class="form-check me-4">
                    <input class="form-check-input" asp-for="MixedFeeding" />
                    <label class="form-check-label">Mixed Feeding</label>
                </div>
                <div class="form-check me-4">
                    <input class="form-check-input" asp-for="BottleFed" />
                    <label class="form-check-label">Bottle Fed</label>
                </div>

                <div class="d-flex align-items-center">
                    <div class="form-check me-2">
                        <input class="form-check-input" asp-for="OthersFeeding" id="OthersFeedingCheckbox" />
                        <label class="form-check-label" for="OthersFeedingCheckbox">Others</label>
                    </div>
                    <input asp-for="OthersFeedingSpecify" id="OthersFeedingSpecify" class="form-control form-control-sm" placeholder="Please specify" style="width:250px;" />
                </div>
            </div>

            <div class="d-flex flex-wrap align-items-center mt-2">
                <div class="form-check me-4">
                    <input class="form-check-input" asp-for="UsingIodizedSalt" />
                    <label class="form-check-label">Using Iodized Salt</label>
                </div>

                <div class="form-check me-4">
                    <input class="form-check-input" asp-for="UsingIFR" />
                    <label class="form-check-label">Using Infant Replacement Formula</label>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Toilet Type</label>
                    <select asp-for="ToiletType" id="ToiletTypeSelect" class="form-select">
                        <option value="">Select...</option>
                        <option>Water-Sealed(Flushes)</option>
                        <option>Open Pit(Basic)</option>
                        <option>Others</option>
                        <option>None</option>
                    </select>
                    <input asp-for="ToiletTypeOther" id="ToiletTypeOther" class="form-control form-control-sm mt-2" placeholder="Please specify toilet type" style="display:none;" />
                </div>

                <div class="col-md-4">
                    <label>Food Production Activity</label>
                    <select asp-for="FoodProductionActivity" id="FoodProductionSelect" class="form-select">
                        <option value="">Select...</option>
                        <option>Vegetable Gardening</option>
                        <option>Poultry/Livestock</option>
                        <option>Fishpond/Fishing</option>
                        <option>Others</option>
                    </select>
                    <input asp-for="FoodProductionActivityOther" id="FoodProductionOther" class="form-control form-control-sm mt-2" placeholder="Please specify activity" style="display:none;" />
                </div>

                <div class="col-md-4">
                    <label>Water Source</label>
                    <select asp-for="WaterSource" id="WaterSourceSelect" class="form-select">
                        <option value="">Select...</option>
                        <option>Well(Dug wells/Deep Wells)</option>
                        <option>Piped(Tap Water)</option>
                        <option>Spring(Natural Sping Water)</option>
                        <option>Others</option>
                    </select>
                    <input asp-for="WaterSourceOther" id="WaterSourceOther" class="form-control form-control-sm mt-2" placeholder="Please specify water source" style="display:none;" />
                </div>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save Household</button>
            <a asp-action="Households" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        (function () {
            // --- helpers ---
            function computeAgeFromDate(d) {
                if (!d) return null;
                const b = new Date(d);
                if (isNaN(b)) return null;
                const now = new Date();
                let age = now.getFullYear() - b.getFullYear();
                const m = now.getMonth() - b.getMonth();
                if (m < 0 || (m === 0 && now.getDate() < b.getDate())) age--;
                return age >= 0 ? age : 0;
            }

            function updateAgeForPair(dateInput, ageInput) {
                if (!dateInput || !ageInput) return;
                const age = computeAgeFromDate(dateInput.value);
                ageInput.value = (age === null) ? '' : age;
            }

            // Parents DOB->Age
            const fatherDob = document.getElementById('FatherDateOfBirth');
            const fatherAge = document.getElementById('FatherAge');
            if (fatherDob && fatherAge) {
                fatherDob.addEventListener('change', () => updateAgeForPair(fatherDob, fatherAge));
                updateAgeForPair(fatherDob, fatherAge);
            }
            const motherDob = document.getElementById('MotherDateOfBirth');
            const motherAge = document.getElementById('MotherAge');
            if (motherDob && motherAge) {
                motherDob.addEventListener('change', () => updateAgeForPair(motherDob, motherAge));
                updateAgeForPair(motherDob, motherAge);
            }

            // Children container wiring
            const childrenContainer = document.getElementById('childrenContainer');

            function wireChildRowInitial(row) {
                const dob = row.querySelector('.child-dob');
                const age = row.querySelector('.child-age');
                if (dob && age) updateAgeForPair(dob, age);

                const occSel = row.querySelector('.child-occupation-select');
                const occOther = row.querySelector('.child-occupation-other');
                if (occSel && occOther) occOther.style.display = (occSel.value === 'Others') ? 'block' : 'none';

                const eduSel = row.querySelector('.child-education-select');
                const eduOther = row.querySelector('.child-education-other');
                if (eduSel && eduOther) eduOther.style.display = (eduSel.value === 'Others') ? 'block' : 'none';
            }

            if (childrenContainer) {
                childrenContainer.querySelectorAll('.child-row').forEach(wireChildRowInitial);

                childrenContainer.addEventListener('change', function (e) {
                    const t = e.target;
                    if (!t) return;

                    if (t.classList && t.classList.contains('child-dob')) {
                        const row = t.closest('.child-row');
                        const ageInput = row ? row.querySelector('.child-age') : null;
                        if (ageInput) updateAgeForPair(t, ageInput);
                    }

                    if (t.matches('.child-occupation-select')) {
                        const row = t.closest('.child-row');
                        const other = row ? row.querySelector('.child-occupation-other') : null;
                        if (other) {
                            other.style.display = (t.value === 'Others') ? 'block' : 'none';
                            if (t.value !== 'Others') other.value = '';
                        }
                    }

                    if (t.matches('.child-education-select')) {
                        const row = t.closest('.child-row');
                        const other = row ? row.querySelector('.child-education-other') : null;
                        if (other) {
                            other.style.display = (t.value === 'Others') ? 'block' : 'none';
                            if (t.value !== 'Others') other.value = '';
                        }
                    }
                });
            }

            // Add / Remove child logic (create rows that match server structure)
            const addBtn = document.getElementById('addChildBtn');
            let childIndex = childrenContainer ? childrenContainer.querySelectorAll('.child-row').length : 0;

            function createChildRow(idx) {
                const div = document.createElement('div');
                div.className = 'card mb-3 p-3 child-row';
                div.setAttribute('data-index', idx);

                div.innerHTML = `
                    <button type="button" class="btn btn-outline-danger btn-sm remove-child" aria-label="Remove child" title="Remove child">Remove</button>

                    <div class="row gx-2 align-items-end">
                        <div class="col-md-3"><label class="form-label small">First Name</label><input name="Children[${idx}].FirstName" class="form-control form-control-sm" /></div>
                        <div class="col-md-2"><label class="form-label small">Middle Name</label><input name="Children[${idx}].MiddleName" class="form-control form-control-sm" /></div>
                        <div class="col-md-2"><label class="form-label small">Last Name</label><input name="Children[${idx}].LastName" class="form-control form-control-sm" /></div>
                        <div class="col-md-2"><label class="form-label small">Extension</label><input name="Children[${idx}].Extension" class="form-control form-control-sm" /></div>
                        <div class="col-md-3"><label class="form-label small">Date of Birth</label><input name="Children[${idx}].DateOfBirth" type="date" class="form-control form-control-sm child-dob" /></div>
                    </div>

                    <div class="row gx-2 mt-2 align-items-end">
                        <div class="col-md-1"><label class="form-label small">Age</label><input name="Children[${idx}].Age" class="form-control form-control-sm child-age" readonly /></div>

                        <div class="col-md-4">
                            <label class="form-label small">Occupation</label>
                            <select name="Children[${idx}].Occupation" class="form-select form-select-sm child-occupation-select">
                                <option value="">Select...</option>
                                <option value="Unemployed">Unemployed</option>
                                <option value="Student">Student</option>
                                <option value="Housewife / Housekeeper">Housewife / Housekeeper</option>
                                <option value="Farmer">Farmer</option>
                                <option value="Fisherman">Fisherman</option>
                                <option value="Driver">Driver</option>
                                <option value="Laborer">Laborer</option>
                                <option value="Vendor">Vendor</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Nurse">Nurse</option>
                                <option value="Office Worker / Clerk">Office Worker / Clerk</option>
                                <option value="Construction Worker">Construction Worker</option>
                                <option value="Security Guard">Security Guard</option>
                                <option value="Business Owner">Business Owner</option>
                                <option value="Factory Worker">Factory Worker</option>
                                <option value="Carpenter">Carpenter</option>
                                <option value="Electrician">Electrician</option>
                                <option value="Plumber">Plumber</option>
                                <option value="Others">Others</option>
                            </select>
                            <input name="Children[${idx}].OccupationOther" class="form-control form-control-sm mt-2 child-occupation-other" placeholder="Please specify" style="display:none;" />
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small">Sex</label>
                            <select name="Children[${idx}].Sex" class="form-select form-select-sm"><option value="">Select...</option><option value="Female">Female</option><option value="Male">Male</option></select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label small">Educational Attainment</label>
                            <select name="Children[${idx}].Education" class="form-select form-select-sm child-education-select"><option value="">Select...</option><option value="Elementary Graduate">Elementary Graduate</option><option value="High School Graduate">High School Graduate</option><option value="College Graduate">College Graduate</option><option value="Others">Others</option></select>
                            <input name="Children[${idx}].EducationOther" class="form-control form-control-sm mt-2 child-education-other" placeholder="Please specify" style="display:none;" />
                        </div>
                    </div>
                `;
                return div;
            }

            if (addBtn && childrenContainer) {
                addBtn.addEventListener('click', function () {
                    const row = createChildRow(childIndex++);
                    childrenContainer.appendChild(row);
                    const first = row.querySelector('input');
                    if (first) first.focus();
                });

                childrenContainer.addEventListener('click', function (e) {
                    const btn = e.target.closest('.remove-child');
                    if (!btn) return;
                    const row = btn.closest('.child-row');
                    if (!row) return;

                    // confirm removal
                    Swal.fire({
                        title: 'Remove child?',
                        text: 'This will remove the child entry from the form.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, remove',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#d33'
                    }).then(result => {
                        if (!result.isConfirmed) return;
                        row.remove();
                        reindexChildren();
                    });
                });
            }

            function reindexChildren() {
                const rows = Array.from(document.querySelectorAll('#childrenContainer .child-row'));
                rows.forEach((row, idx) => {
                    row.setAttribute('data-index', idx);
                    row.querySelectorAll('input[name], select[name], textarea[name]').forEach(el => {
                        const name = el.getAttribute('name');
                        if (!name) return;
                        const newName = name.replace(/^Children\[\d+\]/, `Children[${idx}]`);
                        el.setAttribute('name', newName);
                    });
                });
                childIndex = rows.length;
            }

            // reindex before submit
            const form = document.getElementById('editHouseholdForm');
            if (form) {
                form.addEventListener('submit', function () {
                    reindexChildren();
                });
            }

            // Parent toggles
            function wireParentSelect(idSelect, idOther) {
                const sel = document.getElementById(idSelect);
                const other = document.getElementById(idOther);
                if (!sel || !other) return;
                sel.addEventListener('change', function () {
                    other.style.display = (sel.value === 'Others') ? 'block' : 'none';
                    if (sel.value !== 'Others') other.value = '';
                });
                other.style.display = (sel.value === 'Others') ? 'block' : 'none';
            }
            wireParentSelect('FatherOccupationSelect', 'FatherOccupationOther');
            wireParentSelect('FatherEducationSelect', 'FatherEducationOther');
            wireParentSelect('MotherOccupationSelect', 'MotherOccupationOther');
            wireParentSelect('MotherEducationSelect', 'MotherEducationOther');

            function wireSelect(idSelect, idOther) {
                const s = document.getElementById(idSelect);
                const o = document.getElementById(idOther);
                if (!s || !o) return;
                s.addEventListener('change', function () {
                    o.style.display = (s.value === 'Others') ? 'block' : 'none';
                    if (s.value !== 'Others') o.value = '';
                });
                o.style.display = (s.value === 'Others') ? 'block' : 'none';
            }
            wireSelect('ToiletTypeSelect', 'ToiletTypeOther');
            wireSelect('FoodProductionSelect', 'FoodProductionOther');
            wireSelect('WaterSourceSelect', 'WaterSourceOther');

            // Others feeding input enable/disable
            const othersFeedingCb = document.getElementById('OthersFeedingCheckbox');
            const othersFeedingInput = document.getElementById('OthersFeedingSpecify');
            if (othersFeedingCb && othersFeedingInput) {
                const toggle = () => {
                    if (othersFeedingCb.checked) {
                        othersFeedingInput.removeAttribute('disabled');
                        othersFeedingInput.focus();
                    } else {
                        othersFeedingInput.setAttribute('disabled', 'disabled');
                    }
                };
                othersFeedingCb.addEventListener('change', toggle);
                if (othersFeedingCb.checked) othersFeedingInput.removeAttribute('disabled');
                else othersFeedingInput.setAttribute('disabled', 'disabled');
            }

        })();
    </script>
}
