@using System
@using System.Globalization
@using System.Linq
@using BarangayProject.Models.BhwModel
@model Household

@{
    Layout = "~/Views/Shared/_BhwLayout.cshtml";     // use BHW layout so sidebar matches
    ViewData["Title"] = "Family Details";

    var from = Context.Request.Query["from"].ToString();

    Func<DateTime?, int?> ComputeAge = (dob) =>
    {
        if (!dob.HasValue) return null;
        var today = DateTime.Today;
        var birth = dob.Value.Date;
        var age = today.Year - birth.Year;
        if (today.Month < birth.Month || (today.Month == birth.Month && today.Day < birth.Day)) age--;
        return age >= 0 ? (int?)age : null;
    };

    string FormatDate = "MMM d, yyyy";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
    :root {
        --sidebar-w: 240px;
        --content-gap: 40px;
    }

    body > .main-content {
        margin-left: var(--sidebar-w) !important;
        padding: 28px 48px !important;
        min-height: 100vh;
        width: calc(100% - var(--sidebar-w));
    }

    .container, .container-fluid {
        max-width: none !important;
        width: 100% !important;
    }

    .card.card-compact {
        width: 100%;
    }

    .details-hero {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 1rem;
        width: 100%;
    }

        .details-hero .title {
            line-height: 1;
        }

    .table-compact th, .table-compact td {
        padding: .6rem .8rem;
        vertical-align: middle;
        white-space: nowrap;
    }

    .table-responsive {
        overflow: auto;
        width: 100%;
    }

    .meta-row {
        color: #6b7280;
        font-weight: 600;
    }

    .muted {
        color: #6b7280;
    }

    .resident-role {
        font-weight: 700;
        font-size: .92rem;
    }

    .small-muted {
        font-size: .9rem;
        color: #6b7280;
    }

    .kv-term {
        color: #6b7280;
        font-weight: 600;
    }

    .kv-val {
        font-weight: 600;
    }

    .badge-role {
        background: #eef2ff;
        color: #0b3bff;
        font-weight: 600;
        border-radius: 6px;
        padding: .25rem .45rem;
    }

    @@media (max-width: 991px) {
        body > .main-content {
            margin-left: 0 !important;
            padding: 12px !important;
            width: 100% !important;
        }

        .details-hero {
            flex-direction: column;
            align-items: stretch;
        }

        .table-compact th, .table-compact td {
            white-space: normal;
        }
    }
</style>

@functions {
    public DateTime? GetDobFromResident(object resident)
    {
        if (resident == null) return null;
        Type t = resident.GetType();
        if (t.Namespace != null && (t.Namespace.Contains("Castle") || t.Namespace.Contains("Proxy") || t.Name.Contains("Proxy")))
        {
            t = t.BaseType ?? t;
        }

        var candidateNames = new[] { "DateOfBirth", "DateOfBirthUtc", "DOB", "Dob", "BirthDate", "Birthdate", "Date_Of_Birth" };

        foreach (var name in candidateNames)
        {
            var p = t.GetProperty(name, System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.IgnoreCase);
            if (p == null) continue;
            var raw = p.GetValue(resident);
            if (raw == null) continue;

            if (raw is DateTime dt) { if (dt == DateTime.MinValue) return null; return dt; }
            if (raw is DateTime?) { var ndt = (DateTime?)raw; if (!ndt.HasValue || ndt.Value == DateTime.MinValue) return null; return ndt.Value; }
            if (raw is DateTimeOffset dto) { return dto.DateTime; }
            if (raw is string s && !string.IsNullOrWhiteSpace(s))
            {
                if (DateTime.TryParse(s, System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.AssumeLocal, out var parsed))
                {
                    if (parsed == DateTime.MinValue) return null;
                    return parsed;
                }
                if (DateTime.TryParse(s, out parsed))
                {
                    if (parsed == DateTime.MinValue) return null;
                    return parsed;
                }
            }
        }

        try
        {
            var detailsProp = t.GetProperty("Details", System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.IgnoreCase);
            if (detailsProp != null)
            {
                var detailsVal = detailsProp.GetValue(resident) as string;
                if (!string.IsNullOrWhiteSpace(detailsVal))
                {
                    if (detailsVal.IndexOf("date", StringComparison.OrdinalIgnoreCase) >= 0)
                    {
                        var dateTokens = System.Text.RegularExpressions.Regex.Matches(detailsVal, @"\d{4}-\d{2}-\d{2}");
                        if (dateTokens.Count > 0 && DateTime.TryParse(dateTokens[0].Value, out var parsed))
                        {
                            if (parsed != DateTime.MinValue) return parsed;
                        }
                    }
                }
            }
        }
        catch { }

        return null;
    }
}

<div class="container py-4">
    <div class="details-hero">
        <div class="title">
            <h2 class="mb-1">@Model.FamilyHead</h2>
            <div class="small-muted">Family ID: <span class="fw-semibold">@Model.Id</span></div>
            <div class="muted mt-1">Sitio: <span class="fw-semibold">@((Model.Sitio?.Name) ?? "Unassigned")</span></div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card card-compact p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Residents</h5>
                    <small class="small-muted">Total: <span class="fw-semibold">@((Model.Residents?.Count() ?? 0))</span></small>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-compact mb-0">
                        <thead>
                            <tr>
                                <th style="min-width:110px">Role</th>
                                <th style="min-width:240px">Name</th>
                                <th style="min-width:120px">Sex</th>
                                <th style="min-width:140px">Occupation</th>
                                <th style="min-width:160px">Education</th>
                                <th style="min-width:140px">Date of Birth</th>
                                <th style="min-width:80px">Age</th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (Model.Residents != null && Model.Residents.Any())
                            {
                                foreach (var r in Model.Residents.OrderBy(x => x.Role).ThenBy(x => x.LastName))
                                {
                                    var fullName = $"{r.FirstName} {r.MiddleName} {r.LastName} {r.Extension}".Replace("  ", " ").Trim();
                                    var detailsText = string.Empty;
                                    var detailsProp = r.GetType().GetProperty("Details");
                                    if (detailsProp != null)
                                    {
                                        var dv = detailsProp.GetValue(r);
                                        if (dv != null) detailsText = dv.ToString();
                                    }

                                    DateTime? dob = GetDobFromResident(r);
                                    var age = ComputeAge(dob);

                                    <tr>
                                        <td class="resident-role"><span class="badge-role">@r.Role</span></td>
                                        <td>
                                            <div class="fw-semibold">@fullName</div>
                                            @if (!string.IsNullOrWhiteSpace(detailsText))
                                            {
                                                <div class="small-muted">@detailsText</div>
                                            }
                                        </td>

                                        <td>@(string.IsNullOrWhiteSpace(r.Sex) ? "—" : r.Sex)</td>
                                        <td>@(string.IsNullOrWhiteSpace(r.Occupation) ? "—" : r.Occupation)</td>
                                        <td>@(string.IsNullOrWhiteSpace(r.Education) ? "—" : r.Education)</td>

                                        <td>
                                            @if (dob.HasValue && dob.Value.Year > 1)
                                            {
                                                @dob.Value.ToString(FormatDate, CultureInfo.InvariantCulture)
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </td>

                                        <td>
                                            @if (age.HasValue)
                                            {
                                                @age.Value
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">No residents recorded.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card card-compact p-3 mb-3">
                <h5 class="mb-2">Health</h5>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Mother Pregnant</div>
                        <div class="kv-val">@((Model.Health?.MotherPregnant == true) ? "Yes" : "No")</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Family Planning</div>
                        <div class="kv-val">@((Model.Health?.FamilyPlanning == true) ? "Yes" : "No")</div>
                    </div>

                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Exclusive Breastfeeding</div>
                        <div class="kv-val">@((Model.Health?.ExclusiveBreastfeeding == true) ? "Yes" : "No")</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Mixed Feeding</div>
                        <div class="kv-val">@((Model.Health?.MixedFeeding == true) ? "Yes" : "No")</div>
                    </div>

                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Bottle Fed</div>
                        <div class="kv-val">@((Model.Health?.BottleFed == true) ? "Yes" : "No")</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Others</div>
                        <div class="kv-val">@((Model.Health?.OthersFeeding == true) ? (Model.Health?.OthersFeedingSpecify ?? "Yes") : "No")</div>
                    </div>

                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Using Iodized Salt</div>
                        <div class="kv-val">@((Model.Health?.UsingIodizedSalt == true) ? "Yes" : "No")</div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="kv-term">Using Infant Replacement Formula</div>
                        <div class="kv-val">@((Model.Health?.UsingIFR == true) ? "Yes" : "No")</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card card-compact p-3 mb-3">
                <h5 class="mb-2">Sanitation</h5>
                <div class="mb-2">
                    <div class="kv-term">Toilet Type</div>
                    <div class="kv-val">@Model.Sanitation?.ToiletType</div>
                </div>
                <div class="mb-2">
                    <div class="kv-term">Water Source</div>
                    <div class="kv-val">@Model.Sanitation?.WaterSource</div>
                </div>
                <div class="mb-2">
                    <div class="kv-term">Food Production Activity</div>
                    <div class="kv-val">@Model.Sanitation?.FoodProductionActivity</div>
                </div>
            </div>

            <div class="card card-compact p-3 mb-3">
                <h6 class="mb-2">Quick Actions</h6>
                <div class="d-grid gap-2">
                    <a asp-action="EditFamily" asp-route-id="@Model.Id" class="btn btn-outline-primary">Edit Family</a>
                    <a asp-action="Families" class="btn btn-outline-secondary">Return to Family List</a>
                </div>
            </div>
        </div>
    </div>
</div>
