@model BarangayProject.Models.ForgotPasswordViewModel
@{
    Layout = "~/Views/Shared/_SimpleLayout.cshtml";
    ViewData["Title"] = "Forgot password";
    // Prefer TempData (controller often uses TempData), fall back to ViewBag
    var infoMessage = TempData["InfoMessage"] as string ?? ViewBag.InfoMessage as string;
    var resetLink = TempData["ResetLink"] as string ?? ViewBag.ResetLink as string;
}

<div class="container py-5" style="max-width:520px">
    <h3>Forgot Password</h3>
    <p class="text-muted">Enter your email and we'll generate a password reset link (if account exists).</p>

    @* Show info/error messages *@
    @if (!string.IsNullOrEmpty(infoMessage))
    {
        <div class="alert alert-info small">@infoMessage</div>
    }
    @if (!string.IsNullOrEmpty(TempData["ErrorMessage"] as string))
    {
        <div class="alert alert-danger small">@TempData["ErrorMessage"]</div>
    }

    <form asp-action="ForgotPassword" method="post" novalidate>
        @Html.AntiForgeryToken()
        <div class="mb-3">
            <label asp-for="Email" class="form-label">Email</label>
            <input asp-for="Email" class="form-control" />
            <span asp-validation-for="Email" class="text-danger small"></span>
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-primary">Generate reset link</button>
        </div>
    </form>

    @* Development-only: show reset link and auto-redirect to it if present.
       This is intended for systems without SMTP/email configured.
       Remove or hide this block in production. *@
    @if (!string.IsNullOrEmpty(resetLink))
    {
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title mb-2">Generated reset link (development)</h6>
                <p class="small text-muted mb-2">This link allows you to open the Reset Password page directly. In production you should email this link instead of showing it here.</p>

                <div class="mb-2">
                    <a id="openResetLinkBtn" href="@resetLink" target="_blank" class="btn btn-sm btn-outline-secondary">Open reset link</a>
                    <button id="copyResetLinkBtn" type="button" class="btn btn-sm btn-outline-primary ms-2">Copy link</button>
                </div>

                <div class="small text-break mt-2"><strong>URL:</strong> <code id="resetLinkCode">@resetLink</code></div>
                <div class="small text-muted mt-2">You will be redirected automatically to the reset page in a moment.</div>
            </div>
        </div>

        <script>
            (function () {
                // auto-redirect after a short moment (so user sees the card briefly)
                const link = '@resetLink';
                try {
                    setTimeout(function () {
                        if (link && link.length) {
                            window.location.href = link;
                        }
                    }, 800);
                } catch (e) {
                    console.warn('redirect failed', e);
                }

                // copy-to-clipboard button
                const copyBtn = document.getElementById('copyResetLinkBtn');
                const codeEl = document.getElementById('resetLinkCode');
                if (copyBtn && codeEl) {
                    copyBtn.addEventListener('click', function () {
                        const text = codeEl.innerText || codeEl.textContent || '';
                        if (!text) return;
                        navigator.clipboard?.writeText(text).then(function () {
                            copyBtn.innerText = 'Copied';
                            setTimeout(() => copyBtn.innerText = 'Copy link', 1500);
                        }).catch(function () {
                            // fallback: select and prompt
                            const ta = document.createElement('textarea');
                            ta.value = text;
                            document.body.appendChild(ta);
                            ta.select();
                            document.execCommand('copy');
                            document.body.removeChild(ta);
                            copyBtn.innerText = 'Copied';
                            setTimeout(() => copyBtn.innerText = 'Copy link', 1500);
                        });
                    });
                }
            })();
        </script>
    }

    <div class="mt-3">
        <a asp-action="Login">Back to login</a>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
